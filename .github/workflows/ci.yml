name: CI

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1) Validación estática
    - name: Instalar kubeconform
      run: |
        curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz -o kubeconform.tar.gz
        tar -xzvf kubeconform.tar.gz
        sudo mv kubeconform /usr/local/bin/

    - name: Validar manifiestos
      run: kubeconform kubernetes/

    # 2) Iniciar cluster de kubernetes local
    - name: Iniciar minikube
      uses: medyagh/setup-minikube@master
      with:
        minikube-version: 1.36.0
        kubernetes-version: 1.28.3
    
    # 3) Construcción de contenedores con docker-compose
    - name: Construir contenedores
      run: docker compose build
    
    # 3) Habilitar Politica de ingreso en minikube
    - name: Habilitar Ingress
      run: minikube addons enable ingress
    
    # 4) Aplicar manifiestos validos
    - name: Aplicar manifiestos
      run: 
        kubectl apply -f kubernetes/deployment.yml
        kubectl apply -f kubernetes/configmap.yml
        kubectl apply -f kubernetes/network-policy.yml
        kubectl apply -f kubernetes/secrets.yml
        kubectl apply -f kubernetes/service.yml
        kubectl apply -f kubernetes/statefulset.yaml

    # 5) Verificar secretos y politicas creadas
    - name: Verificar secretos
      run: |
        kubectl get secrets app-secret -o yaml

    - name: Verificar políticas creadas
      run: |
        kubectl get networkpolicy
        kubectl describe networkpolicy python-flask-policy 
    
    # 6) Limpiar estado
    - name: Cleanup
      run: kubectl delete -f kubernetes/

